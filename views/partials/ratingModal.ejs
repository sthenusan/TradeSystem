<!-- Rating Modal -->
<div id="ratingModal" class="modal">
    <div class="modal-content">
        <h4>Rate Your Trading Partner</h4>
        <p>How was your experience trading with <span id="partnerName"></span>?</p>

        <form id="ratingForm" class="rating-form">
            <input type="hidden" id="tradeId" name="tradeId">
            <input type="hidden" id="userId" name="userId">

            <div class="rating-stars">
                <div class="star-rating">
                    <input type="radio" id="star5" name="rating" value="5" />
                    <label for="star5" title="5 stars">★</label>
                    <input type="radio" id="star4" name="rating" value="4" />
                    <label for="star4" title="4 stars">★</label>
                    <input type="radio" id="star3" name="rating" value="3" />
                    <label for="star3" title="3 stars">★</label>
                    <input type="radio" id="star2" name="rating" value="2" />
                    <label for="star2" title="2 stars">★</label>
                    <input type="radio" id="star1" name="rating" value="1" />
                    <label for="star1" title="1 star">★</label>
                </div>
            </div>

            <div class="input-field">
                <textarea id="comment" name="comment" class="materialize-textarea" required></textarea>
                <label for="comment">Your Comments</label>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn waves-effect waves-light">Submit Rating</button>
                <button type="button" class="btn-flat modal-close">Skip</button>
            </div>
        </form>
    </div>
</div>

<style>
    .rating-stars {
        text-align: center;
        margin: 20px 0;
    }

    .star-rating {
        display: inline-block;
        position: relative;
        font-size: 30px;
    }

    .star-rating input {
        display: none;
    }

    .star-rating label {
        color: #ddd;
        cursor: pointer;
        padding: 0 5px;
    }

    .star-rating input:checked~label,
    .star-rating label:hover,
    .star-rating label:hover~label {
        color: #ffd700;
    }

    .rating-form {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        text-align: right;
    }

    .modal-footer button {
        margin-left: 10px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ratingModal = document.getElementById('ratingModal');
        const ratingForm = document.getElementById('ratingForm');
        const partnerNameSpan = document.getElementById('partnerName');
        const tradeIdInput = document.getElementById('tradeId');
        const userIdInput = document.getElementById('userId');

        // Function to show rating modal
        window.showRatingModal = function (ratingInfo) {
            partnerNameSpan.textContent = ratingInfo.otherUserName;
            tradeIdInput.value = ratingInfo.tradeId;
            userIdInput.value = ratingInfo.otherUserId;

            const modalInstance = M.Modal.init(ratingModal, {
                dismissible: false
            });
            modalInstance.open();
        };

        // Handle rating form submission
        ratingForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = {
                tradeId: tradeIdInput.value,
                userId: userIdInput.value,
                rating: document.querySelector('input[name="rating"]:checked').value,
                comment: document.getElementById('comment').value
            };

            try {
                const response = await fetch('/ratings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    M.toast({ html: 'Rating submitted successfully!' });
                    M.Modal.getInstance(ratingModal).close();
                } else {
                    M.toast({ html: data.error || 'Error submitting rating' });
                }
            } catch (error) {
                console.error('Error:', error);
                M.toast({ html: 'Error submitting rating' });
            }
        });
    });
</script>