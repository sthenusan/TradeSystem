<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Trade | Barter Trading</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .item-card {
            border-radius: 12px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .item-card.selected {
            border: 2px solid #059669;
        }

        .item-image {
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }

        .item-title {
            font-weight: 500;
            margin: 8px 0;
            color: #1F2937;
        }

        .item-description {
            color: #6B7280;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .trade-summary {
            background: #F9FAFB;
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .trade-items {
            display: flex;
            gap: 16px;
            margin: 16px 0;
        }

        .trade-section {
            flex: 1;
        }

        .trade-section-title {
            font-weight: 500;
            color: #4B5563;
            margin-bottom: 8px;
        }

        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-item {
            background: white;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .selected-item img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
        }

        .remove-item {
            color: #EF4444;
            cursor: pointer;
        }

        .items-to-offer {
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .items-to-offer .item-card {
            margin: 5px 0;
        }

        .items-to-offer label {
            display: block;
            cursor: pointer;
        }

        .items-to-offer input[type="checkbox"] {
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <%- include('../partials/navbar') %>
        <%- include('../partials/messages') %>

            <main style="background: #f5f5f5; padding: 48px 0;">
                <div class="container">
                    <div class="row">
                        <div class="col s12">
                            <div class="card">
                                <div class="card-content">
                                    <span class="card-title">Propose Trade</span>

                                    <div class="row">
                                        <!-- Requested Item -->
                                        <div class="col s12 m6">
                                            <div class="card">
                                                <div class="card-content">
                                                    <span class="card-title">Item You Want</span>
                                                    <div class="item-card">
                                                        <img src="<%= requestedItem.images[0] %>"
                                                            alt="<%= requestedItem.title %>">
                                                        <h6>
                                                            <%= requestedItem.title %>
                                                        </h6>
                                                        <p>
                                                            <%= requestedItem.description %>
                                                        </p>
                                                        <p><strong>Owner:</strong>
                                                            <%= requestedItem.owner.name %>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Your Items to Offer -->
                                        <div class="col s12 m6">
                                            <div class="card">
                                                <div class="card-content">
                                                    <span class="card-title">Your Items to Offer</span>
                                                    <% if (userItems.length===0) { %>
                                                        <p>You don't have any items to offer. <a href="/items/add">Add
                                                                an item</a> first.</p>
                                                        <% } else { %>
                                                            <form action="/trades" method="POST" id="trade-form">
                                                                <input type="hidden" name="requestedItem"
                                                                    value="<%= requestedItem._id %>">
                                                                <input type="hidden" name="receiverId"
                                                                    value="<%= requestedItem.owner._id %>">

                                                                <div class="items-to-offer">
                                                                    <% userItems.forEach(item=> { %>
                                                                        <div class="item-card">
                                                                            <label>
                                                                                <input type="checkbox"
                                                                                    name="offeredItems"
                                                                                    value="<%= item._id %>"
                                                                                    class="filled-in">
                                                                                <span>
                                                                                    <img src="<%= item.images[0] %>"
                                                                                        alt="<%= item.title %>"
                                                                                        class="item-image">
                                                                                    <h6 class="item-title">
                                                                                        <%= item.title %>
                                                                                    </h6>
                                                                                    <p class="item-description">
                                                                                        <%= item.description %>
                                                                                    </p>
                                                                                </span>
                                                                            </label>
                                                                        </div>
                                                                        <% }) %>
                                                                </div>

                                                                <div class="input-field">
                                                                    <textarea name="message" id="message"
                                                                        class="materialize-textarea"
                                                                        required></textarea>
                                                                    <label for="message">Message to the owner</label>
                                                                </div>

                                                                <button type="submit"
                                                                    class="btn waves-effect waves-light">Propose
                                                                    Trade</button>
                                                            </form>
                                                            <% } %>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <%- include('../partials/footer') %>

                <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        // Initialize Materialize components
                        M.AutoInit();

                        // Handle item selection
                        const itemCards = document.querySelectorAll('.item-card');
                        const offeredItemsInput = document.getElementById('offeredItems');
                        const offeredItemsList = document.getElementById('offered-items-list');
                        const selectedItems = new Set();

                        itemCards.forEach(card => {
                            card.addEventListener('click', function () {
                                const itemId = this.dataset.itemId;
                                const itemTitle = this.querySelector('.item-title').textContent;
                                const itemImage = this.querySelector('.item-image').src;

                                if (selectedItems.has(itemId)) {
                                    selectedItems.delete(itemId);
                                    this.classList.remove('selected');
                                    updateOfferedItemsList();
                                } else {
                                    selectedItems.add(itemId);
                                    this.classList.add('selected');
                                    updateOfferedItemsList();
                                }
                            });
                        });

                        function updateOfferedItemsList() {
                            offeredItemsInput.value = Array.from(selectedItems).join(',');
                            offeredItemsList.innerHTML = '';

                            selectedItems.forEach(itemId => {
                                const card = document.querySelector(`.item-card[data-item-id="${itemId}"]`);
                                const title = card.querySelector('.item-title').textContent;
                                const image = card.querySelector('.item-image').src;

                                const itemElement = document.createElement('div');
                                itemElement.className = 'selected-item';
                                itemElement.innerHTML = `
                        <img src="${image}" alt="${title}">
                        <span>${title}</span>
                        <i class="material-icons tiny remove-item">close</i>
                    `;

                                itemElement.querySelector('.remove-item').addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    selectedItems.delete(itemId);
                                    card.classList.remove('selected');
                                    updateOfferedItemsList();
                                });

                                offeredItemsList.appendChild(itemElement);
                            });
                        }

                        // Form validation
                        const tradeForm = document.getElementById('trade-form');
                        tradeForm.addEventListener('submit', function (e) {
                            const checkedItems = document.querySelectorAll('input[name="offeredItems"]:checked');
                            if (checkedItems.length === 0) {
                                e.preventDefault();
                                alert('Please select at least one item to offer');
                            }
                        });
                    });
                </script>
</body>

</html>