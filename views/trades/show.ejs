<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Details | Barter Trading</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .trade-status {
            padding: 5px 10px;
            border-radius: 16px;
            margin: 10px 0;
            font-weight: bold;
            display: inline-block;
        }

        .status-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-accepted {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-rejected {
            background: #FEE2E2;
            color: #991B1B;
        }

        .status-completed {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-cancelled {
            background: #F3F4F6;
            color: #374151;
        }

        .item-card {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
            background: #fff;
        }

        .item-card img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
        }

        .item-info h6 {
            margin: 0 0 6px 0;
            font-size: 1.1rem;
        }

        .item-info p {
            margin: 0;
            color: #666;
            font-size: 0.95rem;
        }

        .trade-actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }

        .inline-form {
            display: inline;
        }

        .messages-section {
            margin-top: 30px;
        }

        .messages-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .message {
            margin: 10px 0;
            max-width: 70%;
        }

        .message.sent {
            margin-left: auto;
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 10px;
            border-radius: 4px;
            background-color: #f5f5f5;
        }

        .message.sent .message-content {
            background-color: #e3f2fd;
        }

        .message-meta {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .message-form {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <%- include('../partials/navbar') %>
        <%- include('../partials/messages') %>

            <main style="background: #f5f5f5; padding: 48px 0;">
                <div class="container">
                    <div class="card" style="border-radius: 12px;">
                        <div class="card-content">
                            <span class="card-title">
                                Trade with <%= trade.initiator._id.toString()===user._id.toString() ?
                                    `${trade.receiver.firstName} ${trade.receiver.lastName}` :
                                    `${trade.initiator.firstName} ${trade.initiator.lastName}` %>
                            </span>

                            <div class="trade-status status-<%= trade.status.toLowerCase() %>">
                                Status: <%= trade.status %>
                            </div>

                            <div class="row">
                                <div class="col s12 m6">
                                    <h6 style="font-weight:600;">You <%=
                                            trade.initiator._id.toString()===user._id.toString() ? 'Offered'
                                            : 'Received' %>:</h6>
                                    <% (trade.initiator._id.toString()===user._id.toString() ? trade.offeredItems :
                                        trade.requestedItems).forEach(item=> { %>
                                        <div class="item-card">
                                            <img src="/uploads/items/<%= item.images[0] %>" alt="<%= item.title %>">
                                            <div class="item-info">
                                                <h6>
                                                    <%= item.title %>
                                                </h6>
                                                <p>
                                                    <%= item.description %>
                                                </p>
                                            </div>
                                        </div>
                                        <% }) %>
                                </div>

                                <div class="col s12 m6">
                                    <h6 style="font-weight:600;">You <%=
                                            trade.initiator._id.toString()===user._id.toString() ? 'Requested'
                                            : 'Offered' %>:</h6>
                                    <% (trade.initiator._id.toString()===user._id.toString() ? trade.requestedItems :
                                        trade.offeredItems).forEach(item=> { %>
                                        <div class="item-card">
                                            <img src="/uploads/items/<%= item.images[0] %>" alt="<%= item.title %>">
                                            <div class="item-info">
                                                <h6>
                                                    <%= item.title %>
                                                </h6>
                                                <p>
                                                    <%= item.description %>
                                                </p>
                                            </div>
                                        </div>
                                        <% }) %>
                                </div>
                            </div>

                            <!-- Trade Actions -->
                            <% if (trade.status==='Pending' && trade.receiver._id.toString()===user._id.toString()) { %>
                                <div class="trade-actions">
                                    <form action="/trades/<%= trade._id %>/status" method="POST" class="inline-form">
                                        <input type="hidden" name="status" value="Accepted">
                                        <button type="submit" class="btn waves-effect waves-light green">Accept
                                            Trade</button>
                                    </form>
                                    <form action="/trades/<%= trade._id %>/status" method="POST" class="inline-form">
                                        <input type="hidden" name="status" value="Rejected">
                                        <button type="submit" class="btn waves-effect waves-light red">Reject
                                            Trade</button>
                                    </form>
                                </div>
                                <% } else if (trade.status==='Accepted' &&
                                    (trade.initiator._id.toString()===user._id.toString() ||
                                    trade.receiver._id.toString()===user._id.toString())) { %>
                                    <div class="trade-actions">
                                        <form action="/trades/<%= trade._id %>/complete" method="POST"
                                            class="inline-form">
                                            <button type="submit" class="btn waves-effect waves-light blue">Mark as
                                                Completed</button>
                                        </form>
                                    </div>
                                    <% } %>

                                        <!-- Messages Section -->
                                        <div class="messages-section">
                                            <h5>Messages</h5>
                                            <div class="messages-container">
                                                <% trade.messages.forEach(msg=> { %>
                                                    <div
                                                        class="message <%= msg.sender.toString() === user._id.toString() ? 'sent' : 'received' %>">
                                                        <div class="message-content">
                                                            <%= msg.content %>
                                                        </div>
                                                        <div class="message-meta">
                                                            <%= msg.sender.toString()===user._id.toString() ? 'You' :
                                                                (msg.senderName || 'Other' ) %> -
                                                                <%= msg.createdAt ? new
                                                                    Date(msg.createdAt).toLocaleString() :
                                                                    (msg.timestamp ? new
                                                                    Date(msg.timestamp).toLocaleString() : 'Unknown' )
                                                                    %>
                                                        </div>
                                                    </div>
                                                    <% }) %>
                                            </div>
                                            <form action="/trades/<%= trade._id %>/messages" method="POST"
                                                class="message-form">
                                                <div class="input-field">
                                                    <textarea name="content" class="materialize-textarea"
                                                        required></textarea>
                                                    <label for="content">Send a message</label>
                                                </div>
                                                <button type="submit" class="btn waves-effect waves-light">Send</button>
                                            </form>
                                        </div>

                                        <% if (trade.status==='Completed' ) { %>
                                            <div class="rating-section"
                                                style="margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                                                <h3 style="margin-bottom: 16px;">Rate Your Trading Partner</h3>

                                                <% const isInitiator=trade.initiator._id.toString()===user.id %>
                                                    <% const ratingField=isInitiator ? 'initiatorRating'
                                                        : 'receiverRating' %>
                                                        <% const partner=isInitiator ? trade.receiver : trade.initiator
                                                            %>

                                                            <% if (!trade[ratingField].rating) { %>
                                                                <form action="/trades/<%= trade._id %>/rate"
                                                                    method="POST"
                                                                    style="display: flex; flex-direction: column; gap: 16px;">
                                                                    <div
                                                                        style="display: flex; flex-direction: column; gap: 8px;">
                                                                        <label style="font-weight: 500;">Rating for <%=
                                                                                partner.firstName %>
                                                                                <%= partner.lastName %></label>
                                                                        <div style="display: flex; gap: 8px;">
                                                                            <% for(let i=1; i <=5; i++) { %>
                                                                                <label style="cursor: pointer;">
                                                                                    <input type="radio" name="rating"
                                                                                        value="<%= i %>" required
                                                                                        style="display: none;">
                                                                                    <i class="material-icons"
                                                                                        style="color: #ddd; font-size: 32px;">star</i>
                                                                                </label>
                                                                                <% } %>
                                                                        </div>
                                                                    </div>

                                                                    <div
                                                                        style="display: flex; flex-direction: column; gap: 8px;">
                                                                        <label style="font-weight: 500;">Comment
                                                                            (optional)</label>
                                                                        <textarea name="comment" rows="3"
                                                                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                                                                    </div>

                                                                    <button type="submit" style="
                                                background-color: #4CAF50;
                                                color: white;
                                                padding: 12px;
                                                border: none;
                                                border-radius: 6px;
                                                font-size: 16px;
                                                font-weight: 500;
                                                cursor: pointer;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                gap: 8px;">
                                                                        <i class="material-icons">star</i>
                                                                        Submit Rating
                                                                    </button>
                                                                </form>
                                                                <% } else { %>
                                                                    <div style="color: #666;">
                                                                        You have already rated this trade.
                                                                    </div>
                                                                    <% } %>

                                                                        <% if (trade[isInitiator ? 'receiverRating'
                                                                            : 'initiatorRating' ].rating) { %>
                                                                            <div
                                                                                style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                                                                                <h4 style="margin-bottom: 8px;">Rating
                                                                                    from <%= partner.firstName %>
                                                                                        <%= partner.lastName %>
                                                                                </h4>
                                                                                <div
                                                                                    style="display: flex; gap: 4px; margin-bottom: 8px;">
                                                                                    <% const
                                                                                        partnerRating=trade[isInitiator
                                                                                        ? 'receiverRating'
                                                                                        : 'initiatorRating' ].rating %>
                                                                                        <% for(let i=1; i <=5; i++) { %>
                                                                                            <i class="material-icons"
                                                                                                style="color: <%= i <= partnerRating ? '#FFD700' : '#ddd' %>; font-size: 24px;">star</i>
                                                                                            <% } %>
                                                                                </div>
                                                                                <% if (trade[isInitiator
                                                                                    ? 'receiverRating'
                                                                                    : 'initiatorRating' ].comment) { %>
                                                                                    <p style="color: #666;">
                                                                                        <%= trade[isInitiator
                                                                                            ? 'receiverRating'
                                                                                            : 'initiatorRating'
                                                                                            ].comment %>
                                                                                    </p>
                                                                                    <% } %>
                                                                            </div>
                                                                            <% } %>
                                            </div>
                                            <% } %>
                        </div>
                    </div>
                </div>
            </main>

            <%- include('../partials/footer') %>

                <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        M.AutoInit();
                    });

                    // Add star rating interaction
                    document.querySelectorAll('input[name="rating"]').forEach((radio, index) => {
                        radio.addEventListener('change', function () {
                            const stars = document.querySelectorAll('input[name="rating"] + i');
                            stars.forEach((star, i) => {
                                star.style.color = i <= index ? '#FFD700' : '#ddd';
                            });
                        });
                    });
                </script>
</body>

</html>